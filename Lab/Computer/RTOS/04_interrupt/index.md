---
title: Arduio で割り込み！
---

## 割り込みとは？

マイコンには、突発的なイベントをきっかけに、実行中のプログラムを中断し、別の処理を実行するためのしくみがあります。

これを割り込みといいます。

プログラム的にはこういうイメージです。

```C:
interrupt(){
    print("スイッチが押されたよ！");
}

main(){

// なにかの処理

interrupt(); // 割り込み

// 続きの処理

}
```

処理の中に、突然、割り込み関数が出現するという感じです。

割り込みは、いろいろなタイミングで発生しますが、一番わかりやすいのが外部割り込みです。

あるデジタル入力ピンの信号が立ち上がると、割り込みを発生させるというものです。

Arduino の場合、

```C:
attachInterrupt(digitalPinToInterrupt(/*ピン番号*/),/*呼び出される関数*/,/*割り込み発生条件*/);
```

で割り込みを設定できます。そして、

```C:
interrupts(); // 割り込み許可
```

で割り込みを許可します。この関数を実行した時点から、いつでも割り込みが発生する可能性があります。

プログラムの途中で割り込みまれると困る場合、割り込み禁止を設定することができます。

```C:
noInterrupts(); // 割り込み禁止

// ここに割り込まれたくない処理を書く

interrupts(); // 割り込み許可
```

割り込み禁止を使ったら、必ず割り込み許可を実行するようにしましょう。

事故ってもエアバッグが開かなくなります。

## サンプルプログラム

```C:
const INTR = 2; // 割り込みピン番号

interrupt(){
    noInterrupts(); // 割り込み禁止
    Serial.println("Interrupt!");
    interrupts(); // 割り込み許可
}

init(){
    Serial.begin(9600); // シリアルポートを9600bpsで開く
    pinMode(INTR, INPUT_PULLUP); // プルアップ入力
    attachInterrupt(digitalPinToInterrupt(INTR), interrupt, FALLING); // 割り込みを設定
    interrupts(); // 割り込み許可
}

loop(){
    int i=0;
    while(true){i++;} // 処理が走り続ける
}
```

Arduino で割り込みを設定できるのは、デジタル 2 番とデジタル 3 番みたいです。

| 定数    | 割り込み発生条件           |
| ------- | -------------------------- |
| LOW     | Low のとき                 |
| CHANGE  | 状態が変化したとき         |
| RISING  | Low から High になったとき |
| FALLING | High から Low になったとき |
