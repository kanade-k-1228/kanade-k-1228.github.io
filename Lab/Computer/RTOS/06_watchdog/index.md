---
title: Arduino の番犬？ウォッチドッグ使ってみた
---

電車の「デッドマン装置」って知ってますか？

実は、電車のハンドルを握るところはスイッチになっていて、運転手は常に握ってスイッチを ON にしています。

スイッチが OFF のまま数秒経つと、運転手が気絶したと判断して緊急停止します。

さらにさらに、一定時間運転操作がないと、握ったまま気絶してると判断して緊急停止します。

電車の先頭に立って、運転手をみてると、たまにマスコンハンドルの横のボタンを押してるのが見られるとおもいます。

これは、「しばらくマスコン動かしてないけど生きてますよ～」と知らせるためのボタンです。

長い駅間を走ってる快速とかだと見られるはずです。

マイコンにも、正常動作してるか、定期的に確認するためのしくみが備わっています。

## ウォッチドッグとは？

ウォッチドッグは番犬です。

時間をカウントしていて、カウントがオーバーフローすると、吠えてマイコンをリセットします。

ただ、撫でられるとカウンタをリセットします。

```C:
#include <avr/wdt.h>

wdt_enable(/*カウント時間*/);

wdt_reset();
```

マイコンが正常か定期的に確認するウォッチドッグ

趣味で使うぶんには必要ない機能かもですが…

実は、ウォッチドッグには、消費電力を減らすっていう裏技チックな使い方があります。

## ワザップ

```C:
#include <avr/sleep.h>
#include <avr/wdt.h>

void setup(){
  set_sleep_mode(SLEEP_MODE_PWR_DOWN);
  wdt_enable(WDTO_8S);
}

void loop(){

  // 定期実行処理

  sleep_enable();
  sleep_cpu();
}
```

温度のログをとるデバイスを作ってみましょう。

まず、クロック周波数を下げます。（設定方法）

これでより長い周期で wdt を使えます。

ついでに消費電力も下げられます。

内部 EEPROM に書き込みます。

容量が 1k しかないので、一杯になったら外部 EEPROM に移します。
