---
title: 高性能なプロセッサ
---

## プロセッサとは

端的に言えば、メモリから値を読み、メモリを書き換えるステートマシン。

### 命令の種類

#### 1. 演算命令

　レジスタ間で演算する命令。

#### 2. 転送命令

　メモリからロードしたり、メモリにストアする命令。

#### 3. 制御命令

　プログラムの流れを制御する命令。分岐とジャンプ。

#### 4. システム命令

　CPUのシステムに関する命令。例外とか割り込みとか特権とか。

## パイプライン

リソースを時分割して最大限使い続ける。

理想的なパイプラインでは、N段に分けるとスループットがN倍になる。
ただ、実際にはパイプラインをフルで使うことはできない。

### ハザード

#### 1. 構造ハザード

同じ資源を使おうとして止まること。たとえば、メモリポートの競合。RISCはロードストアアーキテクチャでこれを起こさないようにしてる

#### 2. データハザード

命令間のデータの依存関係。→フォワーディング

#### 3. 制御ハザード

バブル（パイプラインで使えてないスロット）を減らして、パイプラインの効率を上げることが目標。

## 分岐予測

## キャッシュ

### キャッシュの方式

ライン単位でキャッシュする。←空間局所性

#### 1.ダイレクトマップ

　ラインごとに入っている場所が固定。たとえば、メモリアドレスを32bit、1ラインを256byte、indexを4bitとしたとき、このようなキャッシュになる。

| index | tag      | line                          |
| ----- | -------- | ----------------------------- |
| 0x0   | 0x123456 | 0x123456_0_00 - 0x123456_0_FF |
| 0x1   | 0x789ABC | 0x789ABC_1_00 - 0x789ABC_1_FF |
| :     | :        | :                             |
| 0xF   | 0x000000 | 0x000000_F_00 - 0x000000_F_FF |

1. addr[11:8] == index のエントリを読みだす
2. addr[31:16] == cache[index].tag なら hit!
3. miss したらメモリから読みだして cache[index] に上書き

○ 検索の実装が簡単  
× indexが同じラインは競合  
→ エントリが空いてるのに追い出されるキャッシュが発生し効率が落ちる

#### 2.フルアソシアティブ

　全てのエントリに全てのラインが入れる。

| tag       | line                          |
| --------- | ----------------------------- |
| 0x1234567 | 0x1234567_00 - 0x123456_0_FF  |
| 0x789ABCE | 0x789ABC_1_00 - 0x789ABC_1_FF |
| :         | :                             |
| 0x0000000 | 0x000000_F_00 - 0x000000_F_FF |

1. addr[32:9] == tag なら hit!
2. miss したら空いてるエントリに書き込む
3. 空いてなければ、最近使ってないところに上書き

○ 良く使うラインが残るのでエントリを効率よく使える  
× 検索時に全エントリを走査する必要がある

#### 3.セットアソシアティブ

　上２つの合わせ技。

| index | tag | line |
| ----- | --- | ---- |
| 0x0   |     |      |
| 0x0   |     |      |
| 0x1   |     |      |
| 0x1   |     |      |
| :     |     |      |
| 0xF   |     |      |

1. addr[11:8] == index のエントリの中から
2. addr[31:16] == tag を探す → hit!
3. miss したら、同じ index の空いてるエントリに書き込む
4. 空いてなければ、最近使ってない方に上書き

### プリフェッチ

### 命令キャッシュ

分岐予測と似てる

### データキャッシュ

## アウト・オブ・オーダ

## レジスタ・リネーミング
